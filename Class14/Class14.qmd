---
title: "Class 14: RNASeq mini project"
author: "Yuntian Zhu (PID: A17816597)"
format: pdf
toc: true
---

## Background

Here we work through a complete RNAseq analysis project. The input data comes from a knock-down experiment of a HOX gene. 

## Data Import

Reading the `counts` and  `metadata` CSV files

```{r}
counts <- read.csv("GSE37704_featurecounts.csv", row.names = 1)
countData <- read.csv("GSE37704_featurecounts.csv", row.names = 1)
metadata <- read.csv("GSE37704_metadata.csv")
```

Check on data structure

```{r}
head(counts)
```

```{r}
metadata
```

Some book-keeping is required as there looks to be a mismatch between metadata and counts columns. 

```{r}
ncol(counts)
```

```{r}
nrow(metadata)
```

Looks like we need to get rid of the first "length" column of our `counts` object.

```{r}
cleancounts <- counts[ , -1]
colnames(cleancounts)
```

```{r}
colnames (cleancounts) == metadata$id
```

> Q1. Complete the code below to remove the troublesome first column from countData

```{r}
# Note we need to remove the odd first $length col
countData <- as.matrix(countData[,-1])
head(countData)
```

##Remove zero count genes

There are lots of genes with zero counts

> Q2. Complete the code below to filter countData to exclude genes (i.e. rows) where we have 0 read count across all samples (i.e. columns).

```{r}
countData = countData[rowSums(countData) > 0, ]
```


```{r}
head(cleancounts)
```

```{r}
to.keep.inds <- rowSums(cleancounts) > 0 
nonzero_counts <- cleancounts[to.keep.inds,]
```

## DESeq analysis

Load the package

```{r, message = FALSE}
library(DESeq2)
```


Set up DESeq

```{r}
dds <- DESeqDataSetFromMatrix(countData = nonzero_counts, 
                              colData = metadata, 
                              design = ~condition)
```

Run DESeq
```{r}
dds <- DESeq(dds)
```

Get results
```{r}
res <- results(dds)
res
```
> Q3. Call the summary() function on your results to get a sense of how many genes are up or down-regulated at the default 0.1 p-value cutoff.

```{r}
summary(res)
```


## Data visualization
Volcano plot

```{r}
library(ggplot2)

ggplot(res) + 
  aes(log2FoldChange, -log(padj)) +
  geom_point()
```
Add threshhold lines for fold-change and p-Value and color our subset of genes

```{r}
res$significance <- "Not significant"
res$significance[res$padj < 0.05 & res$log2FoldChange > 1]  <- "Up"
res$significance[res$padj < 0.05 & res$log2FoldChange < -1] <- "Down"

ggplot(res, aes(x = log2FoldChange, y = -log10(padj), color = significance)) +
  geom_point(alpha = 0.6) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  scale_color_manual(values = c("blue", "grey", "red")) +
  theme_minimal()

```
>Q4. Improve this plot by completing the below code, which adds color and axis labels

```{r}
# Make a color vector for all genes
mycols <- rep("gray", nrow(res))

# Color red the genes with absolute fold change above 2
mycols[ abs(res$log2FoldChange) > 2 ] <- "red"

# Color blue those with adjusted p-value less than 0.01
# and absolute fold change more than 2
inds <- (res$padj < 0.01) & (abs(res$log2FoldChange) > 2)
mycols[ inds ] <- "blue"

plot(
  res$log2FoldChange,
  -log(res$padj),
  col = mycols,
  xlab = "Log2(FoldChange)",
  ylab = "-Log(P-value)"
)

```


## Add Annotation
Add gene symbols and entrez IDs

```{r}
library(AnnotationDbi)
library(org.Hs.eg.db)
```

```{r}
res$symbol <- mapIds(x = org.Hs.eg.db,
       keys = row.names(res),
       keytype = "ENSEMBL",
       column = "SYMBOL")
```

```{r}
res$entrez <- mapIds(x = org.Hs.eg.db,
       keys = row.names(res),
       keytype = "ENSEMBL",
       column = "ENTREZID")
```

>Q5. Use the mapIDs() function multiple times to add SYMBOL, ENTREZID and GENENAME annotation to our results by completing the code below.

```{r}
library("AnnotationDbi")
library("org.Hs.eg.db")

columns(org.Hs.eg.db)

res$symbol = mapIds(org.Hs.eg.db,
    keys = row.names(res),
    keytype = "ENSEMBL",
    column = "SYMBOL",
    multiVals = "first")

res$entrez = mapIds(org.Hs.eg.db,
    keys = row.names(res),
    keytype = "ENSEMBL",
    column = "ENTREZID",
    multiVals = "first")

res$name = mapIds(org.Hs.eg.db,
    keys = row.names(res),
    keytype = "ENSEMBL",
    column = "GENENAME",
    multiVals = "first")

head(res, 10)

```
> Q6. Finally for this section let's reorder these results by adjusted p-value and save them to a CSV file in your current project directory.

```{r}
res = res[order(res$padj), ]
write.csv(res, file = "deseq_results.csv")
```


## Pathway Analysis 

###Run gage analysis with KEGG

```{r, message = FALSE}
library(gage)
library(gageData)
library(pathview)
```

We need a name vector for the input of gage

```{r}
foldchanges <- res$log2FoldChange
names(foldchanges) <- res$entrez # We need to use Entrez ID here for KEGG
head(foldchanges)
```

```{r}
data(kegg.sets.hs)
keggres = gage(foldchanges, gsets = kegg.sets.hs)
```

```{r}
head(keggres$less, 5)
head(keggres$greater, 5)
```
```{r}
pathview(pathway.id = "hsa04110", gene.data = foldchanges)
```

![](hsa04110.pathview.png)

```{r}
pathview(pathway.id = "hsa03030", gene.data = foldchanges)
```

![](hsa03030.pathview.png)

> Q7. Can you do the same procedure as above to plot the pathview figures for the top 5 down-reguled pathways?

```{r}
## Focus on top 5 down-regulated pathways
keggrespathways_down <- rownames(keggres$less)[1:5]

## Extract the 8-character KEGG pathway IDs (e.g., "hsa04110")
keggresids_down <- substr(keggrespathways_down, start = 1, stop = 8)

keggresids_down

```

```{r}
pathview(
    gene.data = foldchanges,
    pathway.id = keggresids_down,
    species = "hsa"
)
```

![](hsa04110.pathview.png)

![](hsa03030.pathview.png)

![](hsa05130.pathview.png)


![](hsa03013.pathview.png)



![](hsa03440.pathview.png)


### GO terms

Same analysis but using GO geneset rather than KEGG
```{r}
data(go.sets.hs)
data(go.subs.hs)

# Focus on Biological Process subset of GO
gobpsets = go.sets.hs[go.subs.hs$BP]

gobpres = gage(foldchanges, gsets=gobpsets, same.dir=TRUE)

lapply(gobpres, head)
```

### Reactome

We can analyze the reactome using web interfaces or R functions.

The website is <https://reactome.org/>. It requires a text format withe gene symbol per line of the genes you want to map to pathways

```{r}
sig_genes <- res[res$padj <= 0.05 & !is.na(res$padj), "symbol"]
head(sig_genes)
```

Write it our to a file

```{r}
write.table(sig_genes, file="significant_genes.txt", row.names=FALSE, col.names=FALSE, quote=FALSE)
```

> Q8. What pathway has the most significant “Entities p-value”? Do the most significant pathways listed match your previous KEGG results? What factors could cause differences between the two methods?

The pathway with the most significant "entities p-value" is "Cell cycle". Both KEGG and Reactome identify Cell Cycle and DNA replication / mitotic processes as the most significantly enriched. Therefore, the results of KEGG and Reactome largely agree with each other, but there are still certain differences. This can be due to different pathway definitions, curation methods, gene coverage, statistics and classifications between KEGG and Reactome.

## Save our results

```{r}
write.csv(res, file = "myresults.csv")
```

